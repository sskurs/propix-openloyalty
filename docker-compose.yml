# This Docker Compose file orchestrates the backend and frontend services.
# It is designed to connect to a PostgreSQL database running on your local machine (the Docker host).

services:
  # ----------------------------------
  # Customer Web App (Next.js) Service
  # ----------------------------------
  customer-web:
    container_name: customer-web
    build:
      context: ./customer-web
      dockerfile: Dockerfile
    ports:
      - "3001:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://customer-api:8081/api
      - API_PROXY_URL=http://customer-api:8081/api
    depends_on:
      - customer-api
    networks:
      - loyalty-network

  # ----------------------------------
  # Backend API (.NET) Service
  # ----------------------------------
  backend:
    container_name: admin-api
    # Specifies that the image should be built from the 'backend-dotnet' directory.
    # You must have a Dockerfile in that folder.
    build:
      context: ./admin-api
      dockerfile: OpenLoyalty.Api/Dockerfile # Assuming Dockerfile is in the Api project folder

    # Maps port 8080 on your host machine to port 80 inside the container.
    # You will access your API at http://localhost:8080
    ports:
      - "5199:8080"

    # Environment variables passed to the container at runtime.
    # These will override the settings in your 'appsettings.json'.
    environment:
      # This is the crucial part for connecting to an external PostgreSQL database.
      # 'host.docker.internal' is a special DNS name that resolves to the IP address
      # of your local machine from within the Docker container.
      #
      # !!! IMPORTANT: Replace 'your_postgres_password' with your actual password.
      - ConnectionStrings__OpenloyaltyDatabase=Host=host.docker.internal;Port=5432;Database=openloyalty;Username=loyaltypro;Password=Propix@123!
      - Kafka__BootstrapServers=kafka:9092
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_HTTP_PORTS=8080

    # Simplified command as migrations are now handled in Program.cs
    command: dotnet OpenLoyalty.Api.dll

    # Places this service on a shared network so the frontend can find it.
    networks:
      - loyalty-network

  # ----------------------------------
  # Customer API (.NET) Service
  # ----------------------------------
  customer-api:
    container_name: customer-api
    build:
      context: ./customer-api
      dockerfile: Dockerfile
    ports:
      - "5123:8081"
    environment:
      - ConnectionStrings__OpenloyaltyDatabase=Host=host.docker.internal;Port=5432;Database=openloyalty;Username=loyaltypro;Password=Propix@123!
      - Kafka__BootstrapServers=kafka:9092
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8081
      - ASPNETCORE_HTTP_PORTS=8081
    command: dotnet OpenLoyalty.Customer.Api.dll
    networks:
      - loyalty-network

  # ----------------------------------
  # Frontend (Next.js) Service
  # ----------------------------------
  frontend:
    container_name: admin-web
    # Specifies that the image should be built from the 'frontend-nextjs' directory.
    # You must have a Dockerfile in that folder.
    build:
      context: ./admin-web
      dockerfile: Dockerfile

    # Maps port 3000 on your host to port 3000 in the container.
    ports:
      - "3000:3000"

    # Environment variables passed to the Next.js app.
    environment:
      # This tells the Next.js app how to find the backend API.
      # 'backend' is the service name defined above. Docker's internal DNS will resolve it.
      - NEXT_PUBLIC_API_URL=http://backend:8080/api
      - API_PROXY_URL=http://backend:8080/api

    # Ensures the backend service is started before the frontend.
    depends_on:
      - backend

    networks:
      - loyalty-network

  # ----------------------------------
  # Worker Engine (.NET) Service
  # ----------------------------------
  worker:
    container_name: worker-engine
    build:
      context: ./worker-engine/worker
      dockerfile: Dockerfile
    environment:
      - ConnectionStrings__WorkerDatabase=Host=host.docker.internal;Port=5432;Database=loyalty_worker;Username=loyaltypro;Password=Propix@123!
      - Kafka__BootstrapServers=kafka:9092
      - Kafka__SubscribeTopics=rules.updates,earning-rule.activated,earning-rule.deactivated,earning-rule.cron.triggered,campaign.created,campaign.updated,transaction.created,wallet.points.added
      - Redis__Connection=redis:6379
    networks:
      - loyalty-network

# Defines the shared network for inter-container communication.
networks:
  loyalty-network:
    name: loyalty-network
    driver: bridge
